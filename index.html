<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Tree Blueprint</title>
    <style>
        :root {
            --bg-color: #2b3a42;
            --grid-line: #3a4b55;
            --node-bg: #1e2a30;
            --text-color: #e0f7fa;
            --accent: #4dd0e1;
            --alive: #00e676;
            --dead: #ff5252;
            --unsure: #ffea00;
            --line-color: #b0bec5;
            --panel-bg: rgba(30, 42, 48, 0.98);
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            user-select: none;
        }

        /* --- Modals & Overlays --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(30, 42, 48, 0.95); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-card {
            background: #1e2a30; border: 2px solid var(--accent);
            padding: 30px; width: 320px; text-align: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.5); border-radius: 8px;
        }

        .hidden { display: none !important; }

        /* Login Specifics */
        .login-btn {
            background: #fff; color: #444; border: none; padding: 12px; width: 100%;
            font-weight: bold; cursor: pointer; display: flex; align-items: center;
            justify-content: center; gap: 10px; margin-top: 20px; border-radius: 4px;
            font-family: sans-serif; transition: background 0.2s;
        }
        .login-btn:hover { background: #f0f0f0; }

        /* Custom Confirmation Modal */
        #confirm-modal { z-index: 3000; background: rgba(0,0,0,0.8); }
        .danger-btn { background: var(--dead); color: white; border: none; font-weight: bold; }
        .danger-btn:hover { background: #d32f2f; }
        .cancel-btn { background: transparent; border: 1px solid #546e7a; color: #aaa; }

        /* Toast Notifications */
        #toast-container {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 4000; pointer-events: none;
        }
        .toast {
            background: var(--panel-bg); border: 1px solid var(--accent); color: var(--accent);
            padding: 10px 20px; border-radius: 20px; margin-top: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); font-size: 12px;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- Main UI Layout --- */
        #ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 100;
        }

        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 50px;
            background: var(--panel-bg); border-bottom: 1px solid var(--accent);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; box-sizing: border-box; pointer-events: auto;
        }

        .top-title { font-weight: bold; font-size: 18px; color: var(--accent); letter-spacing: 2px; }
        
        .status-area { display: flex; align-items: center; gap: 15px; }
        .user-status { font-size: 12px; color: var(--alive); }
        .save-indicator { font-size: 10px; color: #aaa; text-transform: uppercase; transition: color 0.3s; }
        .save-indicator.saving { color: var(--unsure); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* Sidebar Containers */
        .sidebar-left, .sidebar-right {
            position: absolute; top: 60px; bottom: 10px;
            display: flex; flex-direction: column; gap: 10px;
            pointer-events: none; overflow-y: auto; max-height: calc(100vh - 70px);
        }
        .sidebar-left { left: 10px; width: 240px; }
        .sidebar-right { right: 10px; width: 300px; align-items: flex-end; }

        /* Panels */
        .panel {
            background: var(--panel-bg); border: 1px solid var(--grid-line);
            padding: 15px; pointer-events: auto; width: 100%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); border-radius: 4px;
            border-left: 3px solid var(--accent); box-sizing: border-box;
        }

        h2, h3 {
            margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase;
            letter-spacing: 1px; border-bottom: 1px solid var(--grid-line);
            padding-bottom: 5px; color: var(--accent);
        }

        /* Controls */
        button {
            background: #263238; border: 1px solid var(--accent); color: var(--accent);
            padding: 8px; cursor: pointer; font-family: inherit; transition: all 0.2s;
            text-transform: uppercase; font-size: 11px; margin-bottom: 5px; width: 100%;
        }
        button:hover { background: var(--accent); color: #000; }
        .btn-group { display: flex; gap: 5px; }
        .btn-group button { flex: 1; }

        input[type="text"] {
            background: #151e22; border: 1px solid #546e7a; color: white;
            padding: 8px; font-family: inherit; width: 100%; margin-bottom: 10px;
            box-sizing: border-box;
        }

        .status-group { display: flex; gap: 5px; margin-bottom: 10px; }
        .radio-btn {
            flex: 1; padding: 6px 2px; text-align: center; border: 1px solid #546e7a;
            cursor: pointer; font-size: 10px; opacity: 0.5; transition: all 0.2s;
        }
        .radio-btn.active { opacity: 1; font-weight: bold; border-width: 2px; }
        .radio-btn.alive.active { border-color: var(--alive); color: var(--alive); }
        .radio-btn.dead.active { border-color: var(--dead); color: var(--dead); }
        .radio-btn.unsure.active { border-color: var(--unsure); color: var(--unsure); }

        /* --- Canvas --- */
        #viewport {
            width: 100vw; height: 100vh; cursor: grab; transform-origin: 0 0;
            background-image: linear-gradient(var(--grid-line) 1px, transparent 1px),
                            linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 40px 40px; background-position: center;
        }
        #viewport.panning { cursor: grabbing; }
        #content-layer { position: absolute; top: 0; left: 0; transform-origin: 0 0; }

        /* --- Nodes --- */
        .node {
            position: absolute; width: 160px; height: 80px; background: var(--node-bg);
            border: 2px solid #546e7a; display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 10px; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: box-shadow 0.2s, transform 0.1s;
            z-index: 10;
        }
        .node:hover { box-shadow: 0 0 10px var(--accent); }
        .node.selected { border-color: #fff; box-shadow: 0 0 15px var(--accent); z-index: 20; }
        .node[data-status="alive"] { border-top: 4px solid var(--alive); }
        .node[data-status="dead"] { border-top: 4px solid var(--dead); }
        .node[data-status="unsure"] { border-top: 4px solid var(--unsure); }

        .node-name {
            font-weight: bold; text-align: center; margin-bottom: 5px; pointer-events: none;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;
        }
        .node-status { font-size: 10px; opacity: 0.7; text-transform: uppercase; pointer-events: none; }
        
        .collapse-btn {
            position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%);
            width: 20px; height: 20px; background: #263238; border: 1px solid var(--accent);
            color: var(--accent); border-radius: 50%; font-size: 14px; line-height: 18px;
            text-align: center; cursor: pointer; z-index: 25;
        }
        .collapse-btn:hover { background: var(--accent); color: black; }

        /* Connections */
        #connections-layer { position: absolute; top: 0; left: 0; width: 1px; height: 1px; overflow: visible; pointer-events: none; z-index: 5; }
        path { fill: none; stroke: var(--line-color); stroke-width: 2; }
        path.spouse { stroke-dasharray: 5, 5; }
        path.sibling { stroke-dasharray: 2, 2; stroke: var(--unsure); }
    </style>
</head>
<body>

    <!-- Cloud Login Modal -->
    <div id="login-overlay" class="overlay">
        <div class="modal-card">
            <h2 style="font-size: 24px; border-bottom: none; margin-bottom: 5px;">BLUEPRINT STUDIO</h2>
            <p style="color: #aaa; font-size: 12px; margin-bottom: 30px;">Cloud Sync & Storage</p>
            <div style="text-align: left; font-size: 12px; color: #888; margin-bottom: 10px;">
                Sign in to save your family tree securely to the cloud.
            </div>
            <button id="auth-btn" class="login-btn">
                <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.252-.164-1.841H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.715H.957v2.332A8.997 8.997 0 0 0 9 18z"/><path fill="#FBBC05" d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.159 6.656 3.58 9 3.58z"/></svg>
                Sign In with Google
            </button>
            <button id="guest-btn" class="skip-btn" style="background: transparent; border: 1px solid #546e7a; color: #888; margin-top: 10px;">Continue as Guest</button>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="confirm-modal" class="overlay hidden">
        <div class="modal-card" style="border-color: var(--dead);">
            <h2 style="color: var(--dead); border-color: var(--dead);">DELETE WARNING</h2>
            <p style="color: #e0f7fa; font-size: 13px; margin: 20px 0;">
                Are you sure you want to remove <strong id="confirm-name">this person</strong>?<br><br>
                This will also remove lines connected to them.
            </p>
            <div class="btn-group">
                <button class="cancel-btn" onclick="app.closeConfirm()">Cancel</button>
                <button class="danger-btn" onclick="app.executeDelete()">Yes, Delete</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container"></div>

    <!-- Main UI -->
    <div id="ui-layer">
        <div class="top-bar">
            <div class="top-title">FAMILY BLUEPRINT</div>
            <div class="status-area">
                <div id="save-status" class="save-indicator">Synced</div>
                <div class="user-status" id="user-display">Guest Mode</div>
                <button onclick="toggleToolbar()" style="width: auto; padding: 5px 15px;">⚙️ Menu</button>
            </div>
        </div>

        <div class="sidebar-left">
            <div id="tools-panel" class="panel">
                <h3>Controls</h3>
                <button onclick="createNewTree()">+ New Root</button>
                <div class="btn-group">
                    <button onclick="cloudSave()">☁ Force Save</button>
                    <button onclick="cloudLoad()">☁ Load</button>
                </div>
                <button onclick="resetView()">Recenter</button>
                <div style="margin-top: 10px; font-size: 10px; opacity: 0.6; line-height: 1.4;">
                    <strong>Controls:</strong><br>• Drag BG to Pan<br>• Scroll to Zoom<br>• Click Node to Edit
                </div>
            </div>
            <div id="stats-panel" class="panel">
                <h3>Stats</h3>
                <div style="display:flex; justify-content: space-between; font-size: 11px;"><span>Total:</span> <span id="stat-total">0</span></div>
                <div style="display:flex; justify-content: space-between; font-size: 11px;"><span>Alive:</span> <span id="stat-alive" style="color: var(--alive)">0</span></div>
                <div style="display:flex; justify-content: space-between; font-size: 11px;"><span>Passed:</span> <span id="stat-dead" style="color: var(--dead)">0</span></div>
            </div>
        </div>

        <div class="sidebar-right">
            <div id="selection-panel" class="panel hidden">
                <h3>Edit Member</h3>
                <span id="sel-name-display" style="display:block; margin-bottom:10px; color:white; font-weight:bold;">Name</span>
                <input type="text" id="edit-name" placeholder="Full Name">
                <div class="status-group">
                    <div class="radio-btn alive" onclick="app.setNodeStatus('alive')">ALIVE</div>
                    <div class="radio-btn dead" onclick="app.setNodeStatus('dead')">DEAD</div>
                    <div class="radio-btn unsure" onclick="app.setNodeStatus('unsure')">?</div>
                </div>
                <h3>Add Connection</h3>
                <div class="btn-group">
                    <button onclick="app.addRelative('parent')">▲ Parent</button>
                    <button onclick="app.addRelative('child')">▼ Child</button>
                </div>
                <div class="btn-group">
                    <button onclick="app.addRelative('spouse')">❤ Spouse</button>
                    <button onclick="app.addRelative('sibling')">↔ Sibling</button>
                </div>
                <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 10px;">
                    <button style="border-color: #ff5252; color: #ff5252;" onclick="app.showDeleteConfirm()">✖ Delete</button>
                </div>
            </div>
            <div id="search-panel" class="panel">
                <h3>Search</h3>
                <input type="text" id="search-input" placeholder="Type name..." onkeyup="app.performSearch()" style="margin-bottom:0;">
            </div>
        </div>
    </div>

    <div id="viewport">
        <div id="content-layer">
            <svg id="connections-layer"></svg>
            <div id="nodes-layer"></div>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Robust Firebase Initialization ---
        let fbApp, auth, db, currentUser = null;
        let isFirebaseAvailable = false;
        let isUserProject = false;
        // Fixed ID for your project to keep data organized
        const appId = 'family-tree-app'; 
        let autoSaveTimer = null;

        // Your provided config
        const userConfig = {
            apiKey: "AIzaSyCCFW1URrsIk32vDJdF5C736cUWF-6nl_s",
            authDomain: "family-tree-1b33d.firebaseapp.com",
            projectId: "family-tree-1b33d",
            storageBucket: "family-tree-1b33d.firebasestorage.app",
            messagingSenderId: "800154343389",
            appId: "1:800154343389:web:8e16d68fc2e5028a97c834",
            measurementId: "G-PYTH753WDD"
        };

        try {
            // FORCE use of your config
            fbApp = initializeApp(userConfig);
            auth = getAuth(fbApp);
            db = getFirestore(fbApp);
            isFirebaseAvailable = true;
            isUserProject = true;
            console.log("Firebase initialized with YOUR project:", userConfig.projectId);
        } catch (e) {
            console.warn("Firebase User Config Init Failed:", e);
            // Backup: Fallback to environment if your config fails
            try {
                if (typeof __firebase_config !== 'undefined') {
                    const envConfig = JSON.parse(__firebase_config);
                    fbApp = initializeApp(envConfig);
                    auth = getAuth(fbApp);
                    db = getFirestore(fbApp);
                    isFirebaseAvailable = true;
                    isUserProject = false; 
                }
            } catch (err) {
                document.getElementById('user-display').innerText = "Offline Mode";
            }
        }

        // --- App State ---
        const state = {
            nodes: [],
            connections: [],
            selectedId: null,
            nextId: 1,
            view: { x: window.innerWidth/2, y: window.innerHeight/2, scale: 1 },
            isDraggingNode: false,
            isPanning: false,
            dragStart: { x: 0, y: 0 },
            draggedNodeId: null
        };

        // --- Core Application Logic ---
        window.app = {
            init: function() {
                this.centerView();
                this.render();
                
                // Auth Listeners
                document.getElementById('auth-btn').addEventListener('click', this.handleLogin);
                document.getElementById('guest-btn').addEventListener('click', this.handleGuest);

                if (isFirebaseAvailable) {
                    onAuthStateChanged(auth, (user) => {
                        currentUser = user;
                        if (user) {
                            document.getElementById('login-overlay').classList.add('hidden');
                            document.getElementById('user-display').innerText = `User: ${user.uid.substring(0,4)}...`;
                            window.showToast("Signed in. Auto-save enabled.");
                            window.cloudLoad(); // Auto load
                        }
                    });
                }
            },

            handleLogin: async () => {
                if (!isFirebaseAvailable) {
                    window.app.handleGuest();
                    window.showToast("Offline Mode: Cloud save unavailable");
                    return;
                }
                const btn = document.getElementById('auth-btn');
                btn.innerHTML = "Connecting...";
                
                try {
                    // CRITICAL FIX: Since we are using YOUR project config, we CANNOT use the 
                    // environment's custom token. We must use Anonymous Auth.
                    if (isUserProject) {
                        await signInAnonymously(auth);
                    } else {
                        // Environment fallback logic
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                } catch (e) {
                    console.error("Auth failed", e);
                    
                    let msg = "Login failed. Check console.";
                    if(e.code === 'auth/operation-not-allowed') {
                        msg = "Error: Enable 'Anonymous Auth' in Firebase Console!";
                    } else if (e.code === 'auth/api-key-not-valid') {
                         msg = "Error: Invalid API Key in config";
                    }

                    window.showToast(msg);
                    btn.innerHTML = "Sign In with Google"; 
                }
            },

            handleGuest: () => {
                document.getElementById('login-overlay').classList.add('hidden');
                window.addNode(0, 0, "Root Ancestor", "alive");
            },

            // --- Delete System (Modal Based) ---
            showDeleteConfirm: () => {
                if(!state.selectedId) return;
                const node = state.nodes.find(n => n.id === state.selectedId);
                document.getElementById('confirm-name').innerText = node ? node.name : "this person";
                document.getElementById('confirm-modal').classList.remove('hidden');
            },

            closeConfirm: () => {
                document.getElementById('confirm-modal').classList.add('hidden');
            },

            executeDelete: () => {
                const id = state.selectedId;
                if (!id) return;

                state.connections = state.connections.filter(c => c.from !== id && c.to !== id);
                state.nodes = state.nodes.filter(n => n.id !== id);

                window.app.closeConfirm();
                state.selectedId = null;
                document.getElementById('selection-panel').classList.add('hidden');
                
                window.updateStats();
                window.render();
                window.showToast("Member deleted");
                window.triggerAutoSave();
            },

            // --- Node Operations ---
            addNode: (x, y, name = "New Person", status = "unsure") => {
                const id = `n_${Date.now()}_${state.nextId++}`;
                state.nodes.push({ id, x, y, name, status, collapsed: false });
                window.updateStats();
                window.render();
                window.selectNode(id);
                window.triggerAutoSave();
                return id;
            },

            addRelative: (type) => {
                const current = state.nodes.find(n => n.id === state.selectedId);
                if (!current) return;

                const OFFSET = 200;
                let newX = current.x;
                let newY = current.y;
                let newId;

                if (type === 'parent') {
                    newY -= OFFSET;
                    newId = window.app.addNode(newX, newY, "Parent", "alive");
                    window.addConnection(newId, current.id, 'parent');
                } else if (type === 'child') {
                    newY += OFFSET;
                    const siblings = state.connections.filter(c => c.from === current.id && c.type === 'parent');
                    newX += (siblings.length * (OFFSET + 20)); 
                    newId = window.app.addNode(newX, newY, "Child", "alive");
                    window.addConnection(current.id, newId, 'parent');
                } else if (type === 'spouse') {
                    newX += OFFSET + 50;
                    newId = window.app.addNode(newX, newY, "Spouse", "alive");
                    window.addConnection(current.id, newId, 'spouse');
                } else if (type === 'sibling') {
                    newX += OFFSET + 50;
                    const parents = state.connections.filter(c => c.to === current.id && c.type === 'parent');
                    newId = window.app.addNode(newX, newY, "Sibling", "alive");
                    if (parents.length > 0) {
                        parents.forEach(p => window.addConnection(p.from, newId, 'parent'));
                    } else {
                        window.addConnection(current.id, newId, 'sibling');
                    }
                }
            },

            setNodeStatus: (status) => {
                if (state.selectedId) {
                    const node = state.nodes.find(n => n.id === state.selectedId);
                    if(node) {
                        node.status = status;
                        window.updateStats();
                        window.render();
                        window.selectNode(state.selectedId); 
                        window.triggerAutoSave();
                    }
                }
            },

            performSearch: () => {
                const term = document.getElementById('search-input').value.toLowerCase();
                const nodes = document.querySelectorAll('.node');
                
                if(term.length < 2) {
                    nodes.forEach(n => { n.style.opacity = '1'; n.style.boxShadow = ''; });
                    return;
                }

                nodes.forEach(n => {
                    const name = n.querySelector('.node-name').innerText.toLowerCase();
                    if(name.includes(term)) {
                        n.style.opacity = '1';
                        n.style.boxShadow = '0 0 20px yellow';
                    } else {
                        n.style.opacity = '0.2';
                        n.style.boxShadow = 'none';
                    }
                });
            },

            centerView: () => {
                state.view = { x: window.innerWidth / 2, y: window.innerHeight / 2, scale: 1 };
                window.updateTransform();
            },

            render: () => { window.render(); }
        };

        // --- Global Helper Functions ---
        window.createNewTree = () => {
            const x = -state.view.x / state.view.scale + window.innerWidth/2/state.view.scale;
            const y = -state.view.y / state.view.scale + window.innerHeight/2/state.view.scale;
            window.app.addNode(x, y, "New Root", "alive");
        };

        window.toggleToolbar = () => {
            document.getElementById('tools-panel').classList.toggle('hidden');
        };

        window.resetView = window.app.centerView;

        window.addConnection = (fromId, toId, type) => {
            const exists = state.connections.find(c => (c.from === fromId && c.to === toId) || (c.from === toId && c.to === fromId));
            if (!exists) {
                state.connections.push({ from: fromId, to: toId, type });
                window.render();
                window.triggerAutoSave();
            }
        };

        window.showToast = (msg) => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerText = msg;
            container.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3000);
        };

        // --- Render System ---
        window.render = () => {
            const nodesLayer = document.getElementById('nodes-layer');
            const connLayer = document.getElementById('connections-layer');
            nodesLayer.innerHTML = '';
            
            const visibleIds = getVisibleNodeIds();

            state.nodes.forEach(node => {
                if (!visibleIds.has(node.id)) return;

                const el = document.createElement('div');
                el.className = `node ${node.id === state.selectedId ? 'selected' : ''} ${node.collapsed ? 'collapsed' : ''}`;
                el.style.left = node.x + 'px';
                el.style.top = node.y + 'px';
                el.dataset.id = node.id;
                el.dataset.status = node.status;
                el.style.transform = 'translate(-50%, -50%)';

                const hasChildren = state.connections.some(c => c.from === node.id && c.type === 'parent');
                const collapseBtn = hasChildren 
                    ? `<div class="collapse-btn" onclick="toggleCollapse('${node.id}', event)">${node.collapsed ? '+' : '-'}</div>` 
                    : '';

                el.innerHTML = `<div class="node-name">${node.name}</div><div class="node-status">${node.status}</div>${collapseBtn}`;
                
                el.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    state.isDraggingNode = true;
                    state.draggedNodeId = node.id;
                    window.selectNode(node.id);
                });

                nodesLayer.appendChild(el);
            });

            let svgHTML = '';
            state.connections.forEach(conn => {
                if (!visibleIds.has(conn.from) || !visibleIds.has(conn.to)) return;
                const n1 = state.nodes.find(n => n.id === conn.from);
                const n2 = state.nodes.find(n => n.id === conn.to);
                if(n1 && n2) {
                    let d = '';
                    if (conn.type === 'parent') {
                        const p1 = { x: n1.x, y: n1.y + 40 }; 
                        const p2 = { x: n2.x, y: n2.y - 40 };
                        const midY = (p1.y + p2.y) / 2;
                        d = `M ${p1.x} ${p1.y} C ${p1.x} ${midY}, ${p2.x} ${midY}, ${p2.x} ${p2.y}`;
                    } else {
                        d = `M ${n1.x} ${n1.y} L ${n2.x} ${n2.y}`;
                    }
                    svgHTML += `<path d="${d}" class="${conn.type}" />`;
                }
            });
            connLayer.innerHTML = svgHTML;
            window.updateTransform();
        };

        window.updateTransform = () => {
            const content = document.getElementById('content-layer');
            const view = document.getElementById('viewport');
            content.style.transform = `translate(${state.view.x}px, ${state.view.y}px) scale(${state.view.scale})`;
            view.style.backgroundPosition = `${state.view.x}px ${state.view.y}px`;
            view.style.backgroundSize = `${40 * state.view.scale}px ${40 * state.view.scale}px`;
        };

        window.selectNode = (id) => {
            state.selectedId = id;
            const node = state.nodes.find(n => n.id === id);
            if (!node) return;

            const panel = document.getElementById('selection-panel');
            panel.classList.remove('hidden');
            
            document.getElementById('edit-name').value = node.name;
            document.getElementById('sel-name-display').innerText = node.name;
            document.querySelectorAll('.radio-btn').forEach(b => b.classList.remove('active'));
            if(node.status) document.querySelector(`.radio-btn.${node.status}`).classList.add('active');

            window.render();
        };

        window.getVisibleNodeIds = () => {
            let visible = new Set(state.nodes.map(n => n.id));
            let hidden = new Set();
            let queue = [];
            state.nodes.filter(n => n.collapsed).forEach(p => {
                state.connections.filter(c => c.from === p.id && c.type === 'parent').forEach(c => {
                    if(!hidden.has(c.to)) { hidden.add(c.to); queue.push(c.to); }
                });
            });
            while(queue.length > 0) {
                const currentId = queue.shift();
                state.connections.filter(c => c.from === currentId && c.type === 'parent').forEach(c => {
                    if(!hidden.has(c.to)) { hidden.add(c.to); queue.push(c.to); }
                });
            }
            hidden.forEach(id => visible.delete(id));
            return visible;
        };

        window.toggleCollapse = (id, e) => {
            if(e) e.stopPropagation();
            const node = state.nodes.find(n => n.id === id);
            if(node) { node.collapsed = !node.collapsed; window.render(); }
        };

        window.updateStats = () => {
            document.getElementById('stat-total').innerText = state.nodes.length;
            document.getElementById('stat-alive').innerText = state.nodes.filter(n => n.status === 'alive').length;
            document.getElementById('stat-dead').innerText = state.nodes.filter(n => n.status === 'dead').length;
        };

        // --- Event Listeners ---
        document.getElementById('edit-name').addEventListener('input', (e) => {
            if (state.selectedId) {
                const node = state.nodes.find(n => n.id === state.selectedId);
                if(node) {
                    node.name = e.target.value;
                    document.getElementById('sel-name-display').innerText = node.name;
                    window.render();
                    window.triggerAutoSave();
                }
            }
        });

        const viewport = document.getElementById('viewport');
        viewport.addEventListener('mousedown', (e) => {
            if (e.target.closest('.node')) return;
            state.isPanning = true;
            state.dragStart = { x: e.clientX, y: e.clientY };
            viewport.classList.add('panning');
            if(!e.target.closest('#selection-panel') && !e.target.closest('.node')) {
                state.selectedId = null;
                document.getElementById('selection-panel').classList.add('hidden');
                window.render();
            }
        });

        window.addEventListener('mousemove', (e) => {
            if (state.isDraggingNode && state.draggedNodeId) {
                const node = state.nodes.find(n => n.id === state.draggedNodeId);
                if(node) {
                    node.x += e.movementX / state.view.scale;
                    node.y += e.movementY / state.view.scale;
                    const el = document.querySelector(`.node[data-id="${node.id}"]`);
                    if(el) { el.style.left = node.x + 'px'; el.style.top = node.y + 'px'; }
                    window.render(); 
                }
            } else if (state.isPanning) {
                const dx = e.clientX - state.dragStart.x;
                const dy = e.clientY - state.dragStart.y;
                state.view.x += dx; state.view.y += dy;
                state.dragStart = { x: e.clientX, y: e.clientY };
                window.updateTransform();
            }
        });

        window.addEventListener('mouseup', () => {
            if (state.isDraggingNode) { window.triggerAutoSave(); }
            state.isDraggingNode = false; state.draggedNodeId = null; state.isPanning = false;
            viewport.classList.remove('panning');
        });

        viewport.addEventListener('wheel', (e) => {
            e.preventDefault();
            const factor = 1 + (e.deltaY > 0 ? -0.1 : 0.1);
            state.view.scale = Math.max(0.2, Math.min(3, state.view.scale * factor));
            window.updateTransform();
        }, { passive: false });

        // --- Auto-Save System ---
        window.triggerAutoSave = () => {
            if (!currentUser || !isFirebaseAvailable) return;
            
            const indicator = document.getElementById('save-status');
            indicator.innerText = "Saving...";
            indicator.classList.add('saving');
            indicator.style.color = 'var(--unsure)';

            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                window.cloudSave(true); // true = silent mode
            }, 1000); // 1 second debounce
        };

        // --- Cloud Save/Load ---
        window.cloudSave = async (silent = false) => {
            if(!currentUser) { if(!silent) window.showToast("Sign in required"); return; }
            if(!isFirebaseAvailable) { if(!silent) window.showToast("Offline mode"); return; }
            
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'blueprints', 'main_tree');
                await setDoc(docRef, {
                    nodes: state.nodes,
                    connections: state.connections,
                    nextId: state.nextId,
                    view: state.view,
                    updatedAt: new Date().toISOString()
                });
                
                // Success UI Update
                const indicator = document.getElementById('save-status');
                indicator.innerText = "Synced";
                indicator.classList.remove('saving');
                indicator.style.color = '#888';

                if(!silent) window.showToast("Blueprint Saved!");
            } catch(e) {
                console.error(e);
                const indicator = document.getElementById('save-status');
                indicator.innerText = "Error";
                indicator.style.color = 'var(--dead)';
                if(!silent) window.showToast("Save Failed");
            }
        };

        window.cloudLoad = async () => {
            if(!currentUser || !isFirebaseAvailable) return;
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'blueprints', 'main_tree');
                const snapshot = await getDoc(docRef);
                if(snapshot.exists()) {
                    const data = snapshot.data();
                    state.nodes = data.nodes || [];
                    state.connections = data.connections || [];
                    state.nextId = data.nextId || 100;
                    state.view = data.view || state.view;
                    window.updateStats();
                    window.render();
                    document.getElementById('save-status').innerText = "Synced";
                    window.showToast("Loaded from Cloud");
                }
            } catch(e) { console.error(e); }
        };

        window.app.init();
    </script>
</body>
</html>
