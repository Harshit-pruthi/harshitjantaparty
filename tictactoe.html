<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tic Tac Toe | Game Lobby</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Oxanium:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Oxanium', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #1a1a40, #270082);
      color: #d1d1d1;
      min-height: 100vh;
      padding: 20px;
      overflow-x: hidden;
    }

    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #05d9e8;
      color: #1a1a40;
      padding: 12px 24px;
      border-radius: 30px;
      font-weight: bold;
      z-index: 1000;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.5s, fadeOut 0.5s 2.5s forwards;
    }

    @keyframes slideIn {
      from { top: -100px; }
      to { top: 20px; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; visibility: hidden; }
    }

    h1, h2, h3 {
      font-family: 'Orbitron', sans-serif;
      color: #05d9e8;
      text-align: center;
      margin: 20px 0;
      text-shadow: 0 0 10px rgba(5, 217, 232, 0.7);
      letter-spacing: 1px;
    }

    h1 {
      font-size: 2.8rem;
      margin-top: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    button {
      background: linear-gradient(to right, #ff2a6d, #d80077);
      color: white;
      border: none;
      padding: 12px 25px;
      margin: 10px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: bold;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(255, 42, 109, 0.4);
    }

    button:active {
      transform: translateY(1px);
    }

    button i {
      font-size: 1.2rem;
    }

    .back-btn {
      background: #7b42f5;
      margin-bottom: 25px;
    }

    .game-container {
      background: rgba(39, 0, 130, 0.4);
      border-radius: 20px;
      padding: 30px;
      margin: 30px auto;
      max-width: 600px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(5, 217, 232, 0.2);
    }

    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(5, 217, 232, 0.3);
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      color: #05d9e8;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      background-color: #05d9e8;
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 0.7; }
      50% { opacity: 1; }
      100% { opacity: 0.7; }
    }

    .player-info {
      display: flex;
      justify-content: space-around;
      margin: 20px 0;
    }

    .player-card {
      background: rgba(26, 26, 64, 0.7);
      border-radius: 15px;
      padding: 15px;
      width: 45%;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .player-card.active {
      border-color: #05d9e8;
      box-shadow: 0 0 20px rgba(5, 217, 232, 0.5);
      transform: scale(1.03);
    }

    .player-card.winner {
      border-color: #ff2a6d;
      box-shadow: 0 0 20px rgba(255, 42, 109, 0.5);
      transform: scale(1.03);
    }

    .player-avatar {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #ff2a6d, #d80077);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.5rem;
      margin: 0 auto 10px;
    }

    .player-name {
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 5px;
    }

    .player-symbol {
      font-size: 1.8rem;
      font-weight: bold;
      margin-top: 10px;
      color: #05d9e8;
    }

    .game-board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      max-width: 400px;
      margin: 30px auto;
      background: rgba(26, 26, 64, 0.7);
      padding: 20px;
      border-radius: 15px;
    }

    .cell {
      aspect-ratio: 1;
      background: rgba(39, 0, 130, 0.3);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3.5rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .cell:hover {
      background: rgba(39, 0, 130, 0.5);
      transform: translateY(-3px);
    }

    .cell.x {
      color: #ff2a6d;
    }

    .cell.o {
      color: #05d9e8;
    }

    .cell.win {
      background: rgba(5, 217, 232, 0.2);
      border-color: #05d9e8;
      animation: winPulse 1s infinite alternate;
    }

    @keyframes winPulse {
      from { transform: scale(1); box-shadow: 0 0 5px rgba(5, 217, 232, 0.5); }
      to { transform: scale(1.05); box-shadow: 0 0 20px rgba(5, 217, 232, 0.8); }
    }

    .game-status {
      margin: 20px 0;
      padding: 15px;
      background: rgba(39, 0, 130, 0.3);
      border-radius: 15px;
      font-size: 1.2rem;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .game-controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }

    .result-message {
      font-size: 1.8rem;
      font-weight: bold;
      margin: 20px 0;
      color: #ff2a6d;
      text-align: center;
      min-height: 60px;
    }

    .winner-animation {
      animation: winnerAnimation 1s ease infinite alternate;
    }

    @keyframes winnerAnimation {
      0% { transform: scale(1); text-shadow: 0 0 5px rgba(255, 42, 109, 0.5); }
      100% { transform: scale(1.05); text-shadow: 0 0 20px rgba(255, 42, 109, 0.8), 0 0 30px rgba(255, 42, 109, 0.6); }
    }

    .spectator-message {
      text-align: center;
      margin: 30px 0;
      padding: 20px;
      background: rgba(39, 0, 130, 0.3);
      border-radius: 15px;
      font-size: 1.2rem;
      border-left: 4px solid #05d9e8;
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 2.2rem;
      }
      
      .player-info {
        flex-direction: column;
        align-items: center;
        gap: 15px;
      }
      
      .player-card {
        width: 100%;
      }
      
      .game-board {
        max-width: 300px;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.8rem;
      }
      
      .cell {
        font-size: 2.5rem;
      }
    }
  </style>
</head>
<body>
  <div id="notification" class="notification" style="display: none;"></div>
  
  <div class="container">
    <h1><i class="fas fa-times"></i> TIC TAC TOE <i class="fas fa-circle-notch"></i></h1>
    
    <button class="back-btn" onclick="goBackToLobby()"><i class="fas fa-arrow-left"></i> Back to Lobby</button>
    
    <div class="game-container">
      <div class="game-header">
        <h2><i class="fas fa-door-open"></i> Party: <span id="partyCodeDisplay"></span></h2>
        <div class="status-indicator">
          <div class="status-dot"></div>
          <span>Connected</span>
        </div>
      </div>
      
      <div class="player-info">
        <div class="player-card" id="playerXCard">
          <div class="player-avatar" id="playerXAvatar">X</div>
          <div class="player-name" id="playerXName">Player X</div>
          <div class="player-symbol">X</div>
        </div>
        
        <div class="player-card" id="playerOCard">
          <div class="player-avatar" id="playerOAvatar">O</div>
          <div class="player-name" id="playerOName">Player O</div>
          <div class="player-symbol">O</div>
        </div>
      </div>
      
      <div class="game-status" id="gameStatus">
        Setting up the game...
      </div>
      
      <div class="game-board" id="gameBoard">
        <!-- Cells will be generated by JavaScript -->
      </div>
      
      <div class="result-message" id="resultMessage"></div>
      
      <div class="spectator-message" id="spectatorMessage" style="display: none;">
        <i class="fas fa-eye"></i>
        <p>You are spectating the game. Enjoy watching!</p>
      </div>
      
      <div class="game-controls">
        <button onclick="resetGame()"><i class="fas fa-redo"></i> Restart Game</button>
        <button onclick="goBackToLobby()"><i class="fas fa-door-open"></i> Back to Lobby</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD81BzDBcHWpQHtppO3i5vxX7Zs5iQOuOQ",
      authDomain: "harshitjantaparty-77d46.firebaseapp.com",
      projectId: "harshitjantaparty-77d46",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // Get party code and user ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const partyCode = urlParams.get('partyCode');
    const userId = urlParams.get('uid');
    
    let currentUser = null;
    let gameState = null;
    let partyListener = null;
    let playerSymbol = null;
    let playerName = null;
    let playerXName = null;
    let playerOName = null;
    
    // Show notification function
    function showNotification(message) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.display = 'block';
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000);
    }
    
    // Go back to lobby - FIXED: Redirect without parameters
    function goBackToLobby() {
      window.location.href = "index.html";
    }
    
    // Initialize the game
    function initGame() {
      document.getElementById('partyCodeDisplay').textContent = partyCode;
      
      // Listen to party document for game state
      partyListener = db.collection("parties").doc(partyCode)
        .onSnapshot(doc => {
          if (!doc.exists) {
            showNotification("Party not found. Returning to lobby...");
            setTimeout(goBackToLobby, 2000);
            return;
          }
          
          const partyData = doc.data();
          if (!partyData.currentGameState || partyData.currentGame !== 'tictactoe') {
            showNotification("Game not started. Returning to lobby...");
            setTimeout(goBackToLobby, 2000);
            return;
          }
          
          gameState = partyData.currentGameState;
          playerXName = gameState.players[0]?.name || "Player X";
          playerOName = gameState.players[1]?.name || "Player O";
          
          // Update player cards
          document.getElementById('playerXName').textContent = playerXName;
          document.getElementById('playerOName').textContent = playerOName;
          
          // Highlight active player
          document.getElementById('playerXCard').classList.remove('active', 'winner');
          document.getElementById('playerOCard').classList.remove('active', 'winner');
          
          if (!gameState.gameOver) {
            if (gameState.currentPlayer === 'X') {
              document.getElementById('playerXCard').classList.add('active');
            } else {
              document.getElementById('playerOCard').classList.add('active');
            }
          } else {
            if (gameState.winner === 'X') {
              document.getElementById('playerXCard').classList.add('winner');
              document.getElementById('resultMessage').textContent = `${playerXName} Wins!`;
              document.getElementById('resultMessage').classList.add('winner-animation');
            } else if (gameState.winner === 'O') {
              document.getElementById('playerOCard').classList.add('winner');
              document.getElementById('resultMessage').textContent = `${playerOName} Wins!`;
              document.getElementById('resultMessage').classList.add('winner-animation');
            } else if (gameState.winner === 'draw') {
              document.getElementById('resultMessage').textContent = "It's a Draw!";
            }
          }
          
          // Update game status
          if (gameState.gameOver) {
            document.getElementById('gameStatus').textContent = "Game Over";
          } else {
            document.getElementById('gameStatus').textContent = 
              `${gameState.currentPlayer === 'X' ? playerXName : playerOName}'s turn`;
          }
          
          // Render the board
          renderBoard();
          
          // Show spectator message if user is not a player
          const isPlayer = gameState.players.some(player => player.id === userId);
          document.getElementById('spectatorMessage').style.display = isPlayer ? 'none' : 'block';
        });
    }
    
    // Render the game board
    function renderBoard() {
      const boardElement = document.getElementById('gameBoard');
      boardElement.innerHTML = '';
      
      gameState.board.forEach((cellValue, index) => {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.index = index;
        
        if (cellValue === 'X') {
          cell.textContent = 'X';
          cell.classList.add('x');
        } else if (cellValue === 'O') {
          cell.textContent = 'O';
          cell.classList.add('o');
        }
        
        // Highlight winning cells
        if (gameState.winningCells && gameState.winningCells.includes(index)) {
          cell.classList.add('win');
        }
        
        // Add click handler only if it's the player's turn and they are a player
        const isPlayer = gameState.players.some(player => player.id === userId);
        const isPlayersTurn = gameState.players[gameState.currentPlayer === 'X' ? 0 : 1]?.id === userId;
        
        if (!gameState.gameOver && isPlayer && isPlayersTurn && cellValue === '') {
          cell.addEventListener('click', () => makeMove(index));
        } else {
          cell.style.cursor = 'default';
        }
        
        boardElement.appendChild(cell);
      });
    }
    
    // Make a move
    function makeMove(index) {
      // Only allow move if it's the player's turn and the cell is empty
      if (gameState.board[index] !== '' || gameState.gameOver) return;
      
      // Determine which player is making the move
      const playerIndex = gameState.currentPlayer === 'X' ? 0 : 1;
      if (gameState.players[playerIndex]?.id !== userId) return;
      
      // Update local state
      const newBoard = [...gameState.board];
      newBoard[index] = gameState.currentPlayer;
      
      // Check for winner
      const winner = checkWinner(newBoard);
      const winningCells = winner ? getWinningCells(newBoard) : null;
      
      // Update game state
      const newGameState = {
        ...gameState,
        board: newBoard,
        currentPlayer: gameState.currentPlayer === 'X' ? 'O' : 'X',
        gameOver: winner !== null || isBoardFull(newBoard),
        winner: winner || (isBoardFull(newBoard) ? 'draw' : null),
        winningCells: winningCells || null
      };
      
      // Update Firestore
      db.collection("parties").doc(partyCode).update({
        currentGameState: newGameState
      });
    }
    
    // Check for winner
    function checkWinner(board) {
      const winPatterns = [
        [0, 1, 2], [3, 4, 5], [6, 7, 8], // rows
        [0, 3, 6], [1, 4, 7], [2, 5, 8], // columns
        [0, 4, 8], [2, 4, 6]             // diagonals
      ];
      
      for (const pattern of winPatterns) {
        const [a, b, c] = pattern;
        if (board[a] && board[a] === board[b] && board[a] === board[c]) {
          return board[a]; // Return 'X' or 'O'
        }
      }
      
      return null;
    }
    
    // Get winning cells
    function getWinningCells(board) {
      const winPatterns = [
        [0, 1, 2], [3, 4, 5], [6, 7, 8],
        [0, 3, 6], [1, 4, 7], [2, 5, 8],
        [0, 4, 8], [2, 4, 6]
      ];
      
      for (const pattern of winPatterns) {
        const [a, b, c] = pattern;
        if (board[a] && board[a] === board[b] && board[a] === board[c]) {
          return pattern;
        }
      }
      
      return null;
    }
    
    // Check if board is full
    function isBoardFull(board) {
      return board.every(cell => cell !== '');
    }
    
    // Reset the game
    function resetGame() {
      // Only the host can reset the game
      db.collection("parties").doc(partyCode).get().then(doc => {
        if (!doc.exists) return;
        
        const partyData = doc.data();
        if (partyData.hostId !== userId) {
          showNotification("Only the host can reset the game");
          return;
        }
        
        // Reset game state
        const newGameState = {
          board: ['', '', '', '', '', '', '', '', ''],
          currentPlayer: 'X',
          gameOver: false,
          winner: null,
          winningCells: null,
          players: gameState.players // Keep the same players
        };
        
        // Update Firestore
        db.collection("parties").doc(partyCode).update({
          currentGameState: newGameState
        });
        
        // Clear result message
        document.getElementById('resultMessage').textContent = '';
        document.getElementById('resultMessage').classList.remove('winner-animation');
      });
    }
    
    // Initialize when page loads
    window.onload = function() {
      // Add animation to header
      const header = document.querySelector('h1');
      setInterval(() => {
        const hue = Math.floor(Math.random() * 360);
        header.style.textShadow = `0 0 20px hsl(${hue}, 100%, 50%)`;
      }, 2000);
      
      // Initialize the game
      initGame();
    };
  </script>
</body>
</html>
