<!-- Save as tictactoe.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Tic Tac Toe</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <style>
    body {
      background: #0b0c1e;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      padding-top: 40px;
    }
    h1 {
      color: #05d9e8;
    }
    .board {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      grid-gap: 10px;
      justify-content: center;
      margin-top: 30px;
    }
    .cell {
      width: 100px;
      height: 100px;
      background: #270082;
      font-size: 48px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      border-radius: 10px;
    }
    .cell.taken {
      pointer-events: none;
    }
    #status {
      margin-top: 20px;
      font-size: 1.2em;
      color: #ff2a6d;
    }
  </style>
</head>
<body>
  <h1>Tic Tac Toe</h1>
  <h2 id="matchTitle">Loading...</h2>
  <div class="board" id="board"></div>
  <div id="status">Connecting...</div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD81BzDBcHWpQHtppO3i5vxX7Zs5iQOuOQ",
      authDomain: "harshitjantaparty-77d46.firebaseapp.com",
      projectId: "harshitjantaparty-77d46"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const partyCode = urlParams.get('partyCode');
    const uid = urlParams.get('uid');

    let boardRef;
    let playerMark = null;
    let currentTurn = null;
    let playerName = "";
    let player1 = null, player2 = null;

    function createBoard(cells) {
      const boardDiv = document.getElementById("board");
      boardDiv.innerHTML = "";
      cells.forEach((cell, i) => {
        const div = document.createElement("div");
        div.className = "cell" + (cell ? " taken" : "");
        div.textContent = cell || "";
        div.addEventListener("click", () => makeMove(i));
        boardDiv.appendChild(div);
      });
    }

    async function makeMove(index) {
      const snapshot = await boardRef.get();
      const data = snapshot.data();
      if (data.winner || data.cells[index] || data.turn !== playerMark) return;

      const newCells = [...data.cells];
      newCells[index] = playerMark;
      const winner = checkWinner(newCells);

      boardRef.set({
        cells: newCells,
        turn: playerMark === "X" ? "O" : "X",
        winner
      });
    }

    function checkWinner(cells) {
      const wins = [[0,1,2],[3,4,5],[6,7,8],
                    [0,3,6],[1,4,7],[2,5,8],
                    [0,4,8],[2,4,6]];
      for (const [a,b,c] of wins) {
        if (cells[a] && cells[a] === cells[b] && cells[a] === cells[c]) return cells[a];
      }
      return null;
    }

    async function initGame() {
      const partyDoc = await db.collection("parties").doc(partyCode).get();
      const partyData = partyDoc.data();
      const players = partyData.players || [];

      if (players.length < 2) {
        document.getElementById("matchTitle").textContent = "Waiting for 2 players...";
        return;
      }

      player1 = players[0];
      player2 = players[1];
      playerMark = uid === player1.id ? "X" : uid === player2.id ? "O" : null;

      if (!playerMark) {
        document.getElementById("matchTitle").textContent = "Spectating Match";
        document.getElementById("status").textContent = "You are not playing.";
        return;
      }

      document.getElementById("matchTitle").textContent = `${player1.name} (X) vs ${player2.name} (O)`;

      boardRef = db.collection("parties").doc(partyCode).collection("games").doc("tictactoe");
      const boardSnap = await boardRef.get();
      if (!boardSnap.exists) {
        await boardRef.set({
          cells: Array(9).fill(null),
          turn: "X",
          winner: null
        });
      }

      boardRef.onSnapshot(doc => {
        const data = doc.data();
        createBoard(data.cells);
        if (data.winner) {
          document.getElementById("status").textContent = `${data.winner} wins!`;
        } else if (data.cells.every(c => c)) {
          document.getElementById("status").textContent = "It's a draw!";
        } else {
          document.getElementById("status").textContent = data.turn === playerMark ? "Your turn" : "Opponent's turn";
        }
      });
    }

    initGame().catch(err => {
      console.error("Error:", err);
      document.getElementById("status").textContent = "Error loading game.";
    });
  </script>
</body>
</html>
